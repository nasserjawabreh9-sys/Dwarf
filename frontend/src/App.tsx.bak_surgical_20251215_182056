import { useEffect, useMemo, useState } from "react";
import { backendBase, getJSON, postJSON } from "./api";

import StatusPanel from "./components/status/StatusPanel";

type Tab = "Landing" | "Dashboard" | "Settings" | "Console";

function cls(s: string) { return s; }

export default function App() {
  const [tab, setTab] = useState<Tab>("Landing");
  const [now, setNow] = useState<number>(Date.now());

  useEffect(() => {
  const t = setInterval(() => setNow(Date.now()), 1000);
  return () => clearInterval(t);
}, []);
return () => clearInterval(t);
  
}

function TopBar({ tab, setTab, now }: { tab: Tab; setTab: (t:Tab)=>void; now:number; }) {
  
}

function SideBar({ tab, setTab }: { tab: Tab; setTab:(t:Tab)=>void }) {
  const items: {t:Tab, d:string}[] = [
    { t:"Landing", d:"Start & Demo" },
    { t:"Dashboard", d:"Health & Rooms" },
    { t:"Settings", d:"Keys & Integrations" },
    { t:"Console", d:"Ops & Logs" }
  ];
  )}
      <div style={{ marginTop: 12, padding: 10, borderRadius: 12, border:"1px dashed rgba(255,255,255,0.14)", opacity: 0.85 }}>
        <div style={{ fontWeight: 700 }}>Armored Dwarf</div>
        <div style={{ fontSize: 12, opacity: 0.7 }}>Brand slot reserved</div>
      </div>
    </div>
  );
}

function Landing({ setTab }: { setTab:(t:Tab)=>void }) {
  
}

function Dashboard(){
  const [health, setHealth] = useState<any>(null);
  const [rooms, setRooms] = useState<any>(null);
  const [err, setErr] = useState<string>("");

  useEffect(() => {
    (async () => {
      try {
        const h = await getJSON("/healthz");
        const r = await getJSON("/api/rooms");
        setHealth(h);
        setRooms(r);
      } catch (e:any) {
        setErr(String(e?.message || e));
      }
    })();
  
}

function Settings(){
  const [form, setForm] = useState<any>({
    openai_api_key: localStorage.getItem("openai_api_key") || "",
    github_token: localStorage.getItem("github_token") || "",
    github_repo: localStorage.getItem("github_repo") || "",
    render_api_key: localStorage.getItem("render_api_key") || "",
    render_service_id: localStorage.getItem("render_service_id") || "",
    edit_mode_key: localStorage.getItem("edit_mode_key") || "1234",

    tts_key: localStorage.getItem("tts_key") || "",
    webhooks_url: localStorage.getItem("webhooks_url") || "",
    ocr_key: localStorage.getItem("ocr_key") || "",
    web_integration_key: localStorage.getItem("web_integration_key") || "",
    whatsapp_key: localStorage.getItem("whatsapp_key") || "",
    email_smtp: localStorage.getItem("email_smtp") || ""
  const [status, setStatus] = useState<string>("");

  function saveLocal(){
    Object.keys(form).forEach(k => localStorage.setItem(k, String(form[k] ?? "")));
    setStatus("Saved to LocalStorage");
    setTimeout(() => setStatus(""), 1200);
  }

  async function saveBackend(){
    try{
      await postJSON("/api/settings", form);
      setStatus("Saved to Backend");
      setTimeout(() => setStatus(""), 1200);
    }catch(e:any){
      setStatus("Backend error: " + (e?.message||e));
    }
  }

  async function loadBackend(){
    try{
      const r = await getJSON("/api/settings");
      setStatus("Loaded (masked) from Backend");
      console.log("backend settings", r);
      setTimeout(() => setStatus(""), 1200);
    }catch(e:any){
      setStatus("Load error: " + (e?.message||e));
    }
  }

  
}

function Console(){
  const [out, setOut] = useState<string>("");
  const [editKey, setEditKey] = useState<string>(localStorage.getItem("edit_mode_key") || "1234");

  async function gitStatus(){
    try{
      const r = await getJSON("/api/ops/git/status");
      setOut(JSON.stringify(r, null, 2));
    }catch(e:any){
      setOut("Error: " + (e?.message||e));
    }
  }

  async function gitPush(){
    try{
      const r = await postJSON("/api/ops/git/push", { edit_mode_key: editKey, message: "station global build" });
      setOut(JSON.stringify(r, null, 2));
    }catch(e:any){
      setOut("Error: " + (e?.message||e));
    }
  }

  async function dynamoTick(){
    try{
      const r = await postJSON("/api/dynamo/tick", {});
      setOut(JSON.stringify(r, null, 2));
    }catch(e:any){
      setOut("Error: " + (e?.message||e));
    }
  }

  
}

function Card({title, desc}:{title:string; desc:string}){
  
}

function Panel({title, value, body}:{title:string; value:string; body:any}){
  
}

function Field({label, v, onChange, secret}:{label:string; v:string; onChange:(v:string)=>void; secret?:boolean}){
  
}

function StatusBar(){
  
}

const pre: any = {
  whiteSpace:"pre-wrap",
  wordBreak:"break-word",
  background:"rgba(0,0,0,0.35)",
  border:"1px solid rgba(255,255,255,0.10)",
  borderRadius: 14,
  padding: 12,
  minHeight: 180
};

const btnPrimary: any = {
  height: 34, padding:"0 12px", borderRadius: 12,
  border:"1px solid rgba(74,144,226,0.55)",
  background:"rgba(74,144,226,0.28)",
  color:"#eaf2ff", cursor:"pointer", fontWeight: 800
};

const btnGhost: any = {
  height: 34, padding:"0 12px", borderRadius: 12,
  border:"1px solid rgba(255,255,255,0.18)",
  background:"rgba(0,0,0,0.22)",
  color:"#eaf2ff", cursor:"pointer", fontWeight: 700
};
cat > ~/station_root/patch_fix_app_useeffect.sh <<'BASH'
